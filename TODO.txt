POC: JWT + iframe (MainApp -> EmbeddedPages) progress as of 2026-01-14

DONE
- Created solution: JwtIframePoc.sln
- Created projects:
  - MainApp (ASP.NET Core Empty, net8.0)
  - EmbeddedPages (ASP.NET Core Empty, net8.0)
- Added NuGet packages:
  - System.IdentityModel.Tokens.Jwt to both projects
- Added Keys folder:
  - Keys/.gitkeep
  - Keys/mainapp-private.pem (copied by user)
  - Keys/embeddedpages-public.pem (copied by user)

- Added VS Code / Windsurf config:
  - .vscode/launch.json (compound launch created; .NET debugging not supported in Windsurf)
  - .vscode/tasks.json (build + run tasks)

CONFIG ADDED
- MainApp/appsettings.json:
  - Iframe:EmbeddedOrigin = https://localhost:7129
  - Iframe:EmbeddedPath = /embedded
  - Jwt:Issuer = MainApp
  - Jwt:Audience = EmbeddedPages
  - Jwt:PrivateKeyPemPath = ../Keys/mainapp-private.pem
  - Jwt:SecretClaimName = SecretParam
  - Jwt:SecretClaimValue = SecretValue
  - Jwt:TokenLifetimeMinutes = 5

- EmbeddedPages/appsettings.json:
  - Security:AllowedParentOrigin = https://localhost:7053
  - Jwt:Issuer = MainApp
  - Jwt:Audience = EmbeddedPages
  - Jwt:PublicKeyPemPath = ../Keys/embeddedpages-public.pem
  - Jwt:SecretClaimName = SecretParam
  - Jwt:SecretClaimValue = SecretValue

IMPLEMENTED CODE
- MainApp/Program.cs
  - GET / : returns HTML that embeds iframe to EmbeddedPages with query params Param1..3.
  - GET /api/token : reads RSA private key PEM (configured path), mints RS256 JWT with claim SecretParam=SecretValue.
  - No JWT in URL: parent waits for iframe "ready" postMessage, then calls /api/token and sends token to iframe via postMessage.
  - FIX: iframe src HTML was wrong due to raw string escaping (\" in raw string). Removed escapes so src is a valid absolute URL.

- EmbeddedPages/Program.cs
  - Middleware sets CSP header: Content-Security-Policy: frame-ancestors {AllowedParentOrigin}
  - GET / : redirects to /embedded
  - GET /embedded : returns HTML+JS:
    - reads Param1..3 from query string and shows them
    - posts {type:'ready'} to parent
    - listens for {type:'jwt', token:'...'} from parent (origin-checked)
    - calls POST /api/validate with Authorization: Bearer <token>
  - POST /api/validate :
    - reads Authorization header Bearer token
    - loads RSA public key PEM (configured path)
    - validates issuer/audience/signature/lifetime
    - checks claim SecretParam==SecretValue
    - returns 200 OK with basic info, otherwise 401
  - FIX: validation no longer casts validated token to JwtSecurityToken; uses ClaimsPrincipal from ValidateToken (more robust).

BUILD
- dotnet build JwtIframePoc.sln (clean)

OPEN ITEMS / NEXT STEPS
1) Run both apps:
   - Preferred (Windsurf): Tasks: Run Task -> "run: Both apps (watch, https)"
   - Manual:
     - dotnet watch run --project .\EmbeddedPages\EmbeddedPages.csproj --launch-profile https
     - dotnet watch run --project .\MainApp\MainApp.csproj --launch-profile https

2) Navigate to MainApp / and confirm end-to-end:
   - https://localhost:7053/
   - iframe src points to https://localhost:7129/embedded?Param1=Value1&Param2=Value2&Param3=Value3
   - iframe sends ready
   - parent fetches /api/token
   - parent sends token to iframe via postMessage
   - iframe POSTs /api/validate with Bearer token
   - response shows HTTP 200 and JSON with valid=true and secretClaim=SecretValue

3) If build fails with file locked (MainApp.exe):
   - stop the running app(s) first (Ctrl+C / stop task) then rebuild

4) If HTTPS warnings block iframe/navigation:
   - trust dev cert: dotnet dev-certs https --trust

5) If iframe does NOT load:
   - check browser console for postMessage origin mismatch
   - check EmbeddedPages CSP frame-ancestors allows MainApp origin
   - ensure both are using https (origins include scheme)

NOTES
- JWT is NOT passed via URL.
- Token transport uses industry-standard Web Messaging (window.postMessage) between parent and iframe.
- Validation is server-side in EmbeddedPages using Bearer header.

WINDSURF NOTE
- VS Code style .NET debugging is not available in Windsurf (VS Code fork license limitation).
- Use tasks (dotnet watch), logs, and browser devtools; or debug in Visual Studio / Rider if you need breakpoints.
